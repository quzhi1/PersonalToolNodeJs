extends layout

block content
    a(href='/') 主页
    h1 交互中国历史地图
    br
    p#yearsJson(hidden='') #{yearsJson}

    // Map renderer
    img(class ='map')
    br

    // Slide bar
    div#slider-bar

    // Year renderer
    p
        p#amount
        div#output

    br
    br
    p 图片源：布哈林的历史地图。
    p 布哈林的主页：#[a(href="http://www.acfun.cn/u/350475.aspx#") A站链接]
        a(href='http://www.acfun.cn/u/350475.aspx#', target='_blank')
    p 后端支持:
        a(href='mailto:quzhi65222714@gmail.com?Subject=屈直个人工具%20Support%20Request', target='_blank') 屈直

    // Scripts
    script(src='/javascripts/jquery-3.1.1.min.js')
    script(src='/javascripts/jquery-ui.js')
    script.
        // Read years
        var yearsJson = $('#yearsJson').text();
        var years = JSON.parse(yearsJson);
        // console.log(years)

        // Initialize
        var mapImg = $('.map');
        mapImg.attr('src', '/resources/map1/-2100.jpg');

        // Slide bar
        $(function () {
            var slideBar = $('#slider-bar');
            var slideBarValue;
            slideBar.slider({
                range: "max",
                min: -2100,
                max: 2030,
                value: -2100,
                step: 0.5,
                slide: function (event, ui) {
                    // console.log(ui.value)
                    slideBarValue = slideBar.slider("value");

                    // Round value
                    var resultArray = [];
                    var maxDistance = 4017;
                    for (var i = 0; i < years.length; i++) {
                        var pureYear = years[i]
                            .replace('春', '')
                            .replace('夏', '')
                            .replace('秋', '')
                            .replace('冬', '')
                            .replace('月末', '');
                        var yearNum = parseInt(pureYear);
                        if (Math.abs(slideBarValue - yearNum) < maxDistance) {
                            maxDistance = Math.abs(slideBarValue - yearNum);
                            resultArray = [];
                            resultArray.push(years[i]);
                        } else if (Math.abs(slideBarValue - yearNum) === maxDistance) {
                            resultArray.push(years[i]);
                        }
                    }

                    // Chose graph
                    var graphName = resultArray[0]; // TODO: Determine real graph
                    var graphFile = '/resources/map1/' + graphName + '.jpg';
                    mapImg.attr('src', graphFile);
                    // console.log('Rendering ' + graphFile)
                    $("#amount").text('公元：' + graphName);
                }
            });

        });
